{% extends "base.html" %}
{% load static %}
{% block content %}
    <section class="section">
        <div class="container">
            <!-- Language & Lesson Info -->
            <div class="level is-mobile">
                <div class="level-left">
                    <div class="level-item">
                        <div class="tags has-addons">
                            <span class="tag is-dark">Language</span>
                            <span class="tag is-primary">Duala (GACL)</span>
                        </div>
                    </div>
                    <div class="level-item">
                        <div class="tags has-addons">
                            <span class="tag is-dark">Lesson</span>
                            <span class="tag is-info">3/12</span>
                        </div>
                    </div>
                </div>
                <div class="level-right">
                    <div class="level-item">
                        <span class="timer" id="timer">01:45</span>
                    </div>
                </div>
            </div>
            <!-- Progress Bars -->
            <div class="progress-container">
                <div class="columns is-mobile is-vcentered" id="div-accuracy">
                    <div class="column is-2">
                        <span class="has-text-weight-semibold">Accuracy</span>
                    </div>
                    <div class="column">
                        <progress class="progress is-success" value="92" max="100">92%</progress>
                    </div>
                    <div class="column is-1 has-text-right">
                        <span class="has-text-weight-semibold">92%</span>
                    </div>
                </div>
                <div class="columns is-mobile is-vcentered" id="div-speed">
                    <div class="column is-2">
                        <span class="has-text-weight-semibold">Speed</span>
                    </div>
                    <div class="column">
                        <progress class="progress is-info" value="65" max="100">65%</progress>
                    </div>
                    <div class="column is-1 has-text-right">
                        <span class="has-text-weight-semibold">18 WPM</span>
                    </div>
                </div>
            </div>
            <!-- Lesson Text Display -->
            <div class="box mt-5">
                <div class="content is-large" id="lesson-text">
                    <!-- Should be Dynamically filled by JavaScript -->
                    The quick brown fox jumps over the lazy dog.
                </div>
            </div>
            <!-- User Input -->
            <div class="field">
                <div class="control">
                    <input id="user-input"
                           class="input is-large"
                           type="text"
                           placeholder="Type the text above..."
                           autocomplete="off"
                           autocorrect="off"
                           autocapitalize="off"
                           spellcheck="false"
                           autofocus>
                </div>
            </div>
            <!-- Action Buttons -->
            <div class="buttons is-centered mt-5">
                <button id="hint-btn" class="button is-info is-light">
                    <span class="icon">
                        <i class="fas fa-volume-up"></i>
                    </span>
                    <span>Hear Pronunciation</span>
                </button>
                <button id="reset-btn" class="button is-danger is-light" onclick="resetInput()">
                    <span class="icon">
                        <i class="fas fa-redo"></i>
                    </span>
                    <span>Reset</span>
                </button>
                <button id="next-btn" class="button is-success" disabled>
                    <span class="icon">
                        <i class="fas fa-arrow-right"></i>
                    </span>
                    <span>Next Lesson</span>
                </button>
            </div>
            <!-- Virtual Keyboard -->
            <div class="box-mt-5">
                <div id="virtual-keyboard" class="keyboard-container"></div>
            </div>

            {{ writing_system.layout|json_script:"keyboard_layout_data" }}

            <script>
                document.addEventListener("DOMContentLoaded", () => {
                    const layoutElement = document.getElementById('keyboard_layout_data');
                    if (!layoutElement) return;
                    const layoutData = JSON.parse(layoutElement.textContent);
                    const keyboardContainer = document.getElementById('virtual-keyboard');
                    const inputField = document.getElementById('user-input');

                    const createKey = (text, className, onClick) => {
                        const btn = document.createElement('button');
                        btn.className = `button key-btn ${className || ''}`;
                        btn.innerHTML = text;
                        btn.onclick = (e) => {
                            e.preventDefault();
                            onClick();
                            inputField.focus();
                        };
                        return btn;
                    };

                    Object.keys(layoutData).sort().forEach(rowKey => {
                        const rowDiv =document.createElement("div");
                        rowDiv.className = "buttons is-centered mb-2"

                        layoutData[rowKey].forEach(char => {
                            const btn = document.createElement('button');
                            btn.className = "button key-btn"
                            btn.textContent = char;
                            btn.onclick = () => {
                                inputField.value += char;
                                inputField.focus();
                            };
                            rowDiv.appendChild(btn);
                        }
                        );
                        keyboardContainer.appendChild(rowDiv);

                    });

                    const funcRow = document.createElement("div");
                    funcRow.className = "buttons is-centered mb-2";
                    const backspaceBtn = createKey('<i class="fas fa-backspace"></i>', "is-warning", () => {
                        inputField.value = inputField.value.slice(0, -1);
                    });
                    funcRow.appendChild(backspaceBtn);

                    const spaceBtn = createKey("Space", "is-light space-key", () => {
                        inputField.value += " ";
                    });
                    funcRow.appendChild(spaceBtn);

                    const enterBtn = createKey('<i class="fas fa-level-down-alt fa-rotate-90"></i>', "is-success", () => {
                        inputField.value += "\n";
                    });
                    funcRow.appendChild(enterBtn);

                    keyboardContainer.appendChild(funcRow);
                });
            </script>
	    <script src="/static/core/js/typing.js"></script>

            <style>
                .keyboard-row { display: flex; gap: 5px;}
                .key-btn { min-width: 45px;}
            </style>
                </div>
            </section>
{% endblock content %}
